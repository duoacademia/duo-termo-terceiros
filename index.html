<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DUO Academia — Termo de Autorização p/ Terceiros</title>
  <meta name="description" content="Formulário para autorização de uso de cartão por terceiros, com termo e assinatura por touch (gera PDF)." />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e5e7eb; --line:#1f2937; --brand:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--fg);}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 0 24px;border-bottom:1px solid var(--line)}
    h1{font-size:20px;margin:0;font-weight:700}
    .badge{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:20px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:16px;margin:0 0 12px}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    .row-1{grid-template-columns:1fr}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;background:#0b1220;border:1px solid #1c2536;color:var(--fg);border-radius:10px;padding:12px;outline:none}
    input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .help{font-size:12px;color:var(--muted);margin-top:4px}
    .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .btn{appearance:none;border:1px solid #2a3448;background:#162136;color:#dbeafe;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--brand); border-color:var(--brand); color:white}
    .btn.success{background:var(--ok); border-color:var(--ok); color:#001a07}
    .btn.danger{background:var(--danger); border-color:var(--danger); color:white}
    .terms{border:1px dashed #334155;border-radius:12px;padding:12px; background:#0b1220; max-height:220px; overflow:auto;}
    .checkbox{display:flex;gap:10px;align-items:center;margin:12px 0}
    .checkbox input.ck{appearance:none; -webkit-appearance:none; width:22px; height:22px; border:2px solid #334155; border-radius:6px; background:#fff; display:inline-grid; place-content:center; cursor:pointer; outline:none}
    .checkbox input.ck::before{content:""; width:14px; height:14px; transform:scale(0); transition:120ms transform ease-in-out; background:var(--brand); border-radius:4px}
    .checkbox input.ck:checked::before{transform:scale(1)}
    .checkbox span{font-size:14px; color:#e5e7eb; font-weight:600}
    .checkbox input.ck:focus{box-shadow:0 0 0 3px rgba(59,130,246,.35)}
    .sig-wrap{background:#0b1220;border:1px solid #1c2536;border-radius:12px;padding:12px}
    canvas{width:100%;height:220px;background:#ffffff;border-radius:8px;border:1px solid #334155;touch-action: none;}
    .preview{position:sticky; top:24px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:#1f2937;border:0;margin:12px 0}
    footer{margin-top:20px;font-size:12px;color:var(--muted);text-align:center}
    /* Printable area */
    .sheet{background:white;color:#111; width:794px; min-height:1123px; padding:28mm 20mm; border:1px solid #ddd; border-radius:6px; box-shadow:0 4px 30px rgba(0,0,0,.15);
      /* 1) Melhorar espaçamento no PDF renderizado */
      word-spacing: .06em; letter-spacing: .01em; text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; font-kerning: normal; hyphens: none; word-break: normal; overflow-wrap: anywhere;
    }
    .sheet h3, .sheet th, .sheet strong, .sheet .title-tight {
      word-spacing: .08em; letter-spacing: .02em;
    }
    .sheet h3{margin:0 0 8px}
    .sheet small{color:#555}
    .sheet .section{margin-top:14px}
    .sheet table{width:100%; border-collapse:collapse; font-size:13px}
    .sheet th,.sheet td{border:1px solid #ccc; padding:6px 8px; text-align:left}
    .sheet .sign-area{display:flex; gap:16px; align-items:flex-end; margin-top:24px}
    .sheet .sign-box{flex:1}
    /* 2) Não esticar a assinatura: manter proporção e centralizar */
    .sheet .sign-img{max-width:100%; height:auto; max-height:130px; width:auto; border:1px solid #ccc;border-radius:4px;object-fit:contain; display:block; margin:0 auto}
    .sheet .line{height:1px;background:#ccc;margin:6px 0}
    .sheet .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>DUO Academia · Autorização para uso de cartão por terceiros</h1>
        <div class="badge">Preencha, aceite o termo e assine com o dedo (ou mouse). Depois gere o PDF.</div>
      </div>
      <div class="badge">v1.3</div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>1) Dados do titular do cartão</h2>
        <div class="row">
          <div>
            <label for="titular_nome">Nome completo</label>
            <input id="titular_nome" required placeholder="Ex.: João da Silva" />
          </div>
          <div>
            <label for="titular_cpf">CPF</label>
            <input id="titular_cpf" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" />
            <div class="help">Validado somente ao gerar o PDF.</div>
          </div>
        </div>

        <h2 style="margin-top:18px">2) Dados do cartão</h2>
        <div class="row">
          <div>
            <label for="ultimos4">Quatro últimos dígitos</label>
            <input id="ultimos4" inputmode="numeric" maxlength="4" placeholder="1234" />
            <div class="help">Apenas 4 dígitos.</div>
          </div>
          <div>
            <label for="bandeira">Bandeira (opcional)</label>
            <select id="bandeira">
              <option value="">Selecione…</option>
              <option>Visa</option>
              <option>Mastercard</option>
              <option>Elo</option>
              <option>Amex</option>
              <option>Hipercard</option>
              <option>Outros</option>
            </select>
          </div>
        </div>

        <h2 style="margin-top:18px">3) Dados do contratante (terceiro que usará o cartão)</h2>
        <div class="row">
          <div>
            <label for="contratante_nome">Nome completo</label>
            <input id="contratante_nome" required placeholder="Ex.: Maria Oliveira" />
          </div>
          <div>
            <label for="contratante_cpf">CPF</label>
            <input id="contratante_cpf" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" />
          </div>
        </div>

        <h2 style="margin-top:18px">4) Termo de liberação</h2>
        <div class="terms" id="termoTexto" aria-readonly="true">
          <strong>DUO ACADEMIA</strong><br>
          Av. Simoa Gomes, 726 – Heliópolis · R. Dom José, 187. Santo Antônio.<br>
          (87) 9 9666-0021 | (87) 9 9934-1230 · coordenacaoduoacademia@gmail.com<br>
          <div class="hr"></div>
          <div class="title-tight" style="text-align:center;font-weight:700;margin:6px 0 12px">TERMO DE AUTORIZAÇÃO PARA USO DE CARTÃO DE CRÉDITO/DÉBITO POR TERCEIROS</div>
          <div class="section">
            <div style="font-weight:600;">[DADOS DO TITULAR DO CARTÃO]</div>
            NOME COMPLETO: <span class="mono" id="tt_pre_titular">____________________________</span><br>
            NÚMERO DO CPF: <span class="mono" id="tt_pre_cpf_titular">___.___.___-__</span>
          </div>
          <div class="section">
            <div style="font-weight:600;">[DADOS DO CARTÃO UTILIZADO]</div>
            QUATRO ÚLTIMOS DÍGITOS: <span class="mono" id="tt_pre_u4">____</span>
          </div>
          <div class="section">
            <div style="font-weight:600;">[DADOS DO CONTRATANTE DO PLANO]</div>
            NOME COMPLETO: <span class="mono" id="tt_pre_contratante">____________________________</span><br>
            NÚMERO DO CPF: <span class="mono" id="tt_pre_cpf_contratante">___.___.___-__</span>
          </div>
          <div class="section">
            <div><strong>CONTRATADA:</strong> DUO Academia – Unidade Heliópolis, CNPJ 04.574.106/0001-50, e DUO Academia – Unidade Centro, CNPJ 10.619.001/0001-72.</div>
          </div>
          <div class="section" style="font-style:italic">
            <strong>Parágrafo único.</strong> O TITULAR autoriza a CONTRATADA a utilizar o cartão de crédito e/ou débito dele para realizar a adesão de algum contrato, produto ou serviço para o CONTRATANTE, assumindo responsabilidade em caso de eventuais situações interpessoais entre TITULAR e CONTRATANTE.
          </div>
        </div>
        <label class="checkbox">
          <input id="aceite" class="ck" type="checkbox">
          <span>Declaro que li e concordo com o termo acima.</span>
        </label>

        <h2 style="margin-top:18px">5) Assinatura (rúbrica no touch)</h2>
        <div class="row">
          <div>
            <label for="data_assinatura">Data da assinatura</label>
            <input id="data_assinatura" type="date" />
          </div>
        </div>
        <div class="sig-wrap" style="margin-top:10px">
          <div class="row-1 row">
            <div>
              <label>Assine no quadro abaixo</label>
              <canvas id="signaturePad" width="900" height="350" aria-label="Área para assinatura com o dedo ou mouse"></canvas>
              <div class="buttons">
                <button class="btn" id="btnLimpar">Limpar</button>
              </div>
              <div class="help">Dica: gire o celular para paisagem se precisar de mais espaço.</div>
            </div>
          </div>
        </div>

        <div class="buttons">
          <button class="btn success" id="btnPDF">Gerar PDF</button>
          <button class="btn danger" id="btnReset">Resetar formulário</button>
        </div>
      </div>

      <div class="card preview">
        <h2>Pré-visualização do documento (PDF)</h2>
        <div class="help">A prévia atualiza automaticamente conforme você preenche.</div>
        <div id="printArea" class="sheet" aria-label="Área imprimível">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
              <h3>DUO ACADEMIA</h3>
              <small>Av. Simoa Gomes, 726 – Heliópolis · R. Padre Pedro Pacífico, 9 – Santo Antônio<br>
              (87) 9 9666-0021 | (87) 9 9934-1230 · coordenacaoduoacademia@gmail.com</small>
            </div>
            <div style="text-align:right">
              <div style="font-size:12px;color:#444">Código: <span id="doc_id"></span></div>
              <div style="font-size:12px;color:#444">Data: <span id="doc_data"></span></div>
            </div>
          </div>
          <div class="line"></div>
          <div class="title-tight" style="text-align:center;font-weight:700;margin:6px 0 12px">TERMO DE AUTORIZAÇÃO PARA USO DE CARTÃO DE CRÉDITO/DÉBITO POR TERCEIROS</div>

          <div class="section">
            <table>
              <tr><th colspan="2">DADOS DO TITULAR DO CARTÃO</th></tr>
              <tr><td>Nome</td><td id="pv_titular_nome"></td></tr>
              <tr><td>CPF</td><td id="pv_titular_cpf"></td></tr>
            </table>
          </div>

          <div class="section">
            <table>
              <tr><th colspan="2">DADOS DO CARTÃO UTILIZADO</th></tr>
              <tr><td>Últimos 4 dígitos</td><td id="pv_u4"></td></tr>
              <tr><td>Bandeira</td><td id="pv_bandeira"></td></tr>
            </table>
          </div>

          <div class="section">
            <table>
              <tr><th colspan="2">DADOS DO CONTRATANTE DO PLANO</th></tr>
              <tr><td>Nome</td><td id="pv_contratante_nome"></td></tr>
              <tr><td>CPF</td><td id="pv_contratante_cpf"></td></tr>
            </table>
          </div>

          <div class="section" style="font-size:13px">
            <strong>CONTRATADA:</strong> DUO Academia – Unidade Heliópolis, inscrita sob o CNPJ de n.º 04.574.106/0001-50, e DUO Academia – Unidade Centro, inscrita sob o CNPJ de n.º 10.619.001/0001-72.
          </div>

          <div class="section" style="font-size:13px">
            <strong>Parágrafo único.</strong> O TITULAR autoriza a CONTRATADA a utilizar o cartão de crédito e/ou débito dele para realizar a adesão de algum contrato, produto ou serviço para o CONTRATANTE, assumindo responsabilidade em caso de eventuais situações interpessoais entre TITULAR e CONTRATANTE.
          </div>

          <div class="section sign-area">
            <div class="sign-box">
              <div style="margin-bottom:6px">Assinante: <span id="pv_quem">Titular do Cartão</span></div>
              <img id="pv_assinatura" class="sign-img" alt="Assinatura" />
              <div class="line"></div>
              <div style="font-size:12px;color:#555">Assinatura (rúbrica)</div>
            </div>
          </div>
        </div>
        <footer>
          Dica: você também pode usar <strong>Imprimir &gt; Salvar como PDF</strong> se preferir.
        </footer>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // JS idêntico ao v1.2 (sem mudanças de lógica) -----------------------
    const $ = (sel) => document.querySelector(sel);
    const docId = () => new Date().toISOString().replace(/[-:TZ.]/g, '').slice(0, 14);
    const onlyDigits = (v) => (v||'').replace(/\\D+/g,'');

    const maskCPF = (v) => {
      v = onlyDigits(v).slice(0,11);
      return v.replace(/(\\d{3})(\\d)/, '$1.$2')
              .replace(/(\\d{3})(\\d)/, '$1.$2')
              .replace(/(\\d{3})(\\d{1,2})$/, '$1-$2');
    };

    function isValidCPF(cpf){
      cpf = onlyDigits(cpf);
      if (cpf.length !== 11) return false;
      if (/^(\\d)\\1{10}$/.test(cpf)) return false;
      let sum = 0, rest;
      for (let i=1;i<=9;i++) sum += parseInt(cpf.substring(i-1,i)) * (11 - i);
      rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(cpf.substring(9,10))) return false;
      sum = 0; for (let i=1;i<=10;i++) sum += parseInt(cpf.substring(i-1,i)) * (12 - i);
      rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; return rest === parseInt(cpf.substring(10,11));
    }

    function setTodayBR(){
      try{
        const parts = new Intl.DateTimeFormat('pt-BR', {
          timeZone: 'America/Fortaleza',
          day: '2-digit', month: '2-digit', year: 'numeric'
        }).formatToParts(new Date());
        const dd = parts.find(p => p.type === 'day').value;
        const mm = parts.find(p => p.type === 'month').value;
        const yyyy = parts.find(p => p.type === 'year').value;
        const iso = `${yyyy}-${mm}-${dd}`;
        $('#data_assinatura').value = iso;
        $('#doc_data').textContent = `${dd}/${mm}/${yyyy}`;
      }catch(e){
        const tz = new Date();
        const yyyy = tz.getFullYear();
        const mm = String(tz.getMonth()+1).padStart(2,'0');
        const dd = String(tz.getDate()).padStart(2,'0');
        $('#data_assinatura').value = `${yyyy}-${mm}-${dd}`;
        $('#doc_data').textContent = `${dd}/${mm}/${yyyy}`;
      }
    }

    const formatDateBR = (inputDate) => {
      if (!inputDate) return '';
      const [y,m,d] = inputDate.split('-');
      return `${d}/${m}/${y}`;
    };

    // Live masks
    $('#titular_cpf').addEventListener('input', (e)=> e.target.value = maskCPF(e.target.value));
    $('#contratante_cpf').addEventListener('input', (e)=> e.target.value = maskCPF(e.target.value));
    $('#ultimos4').addEventListener('input', (e)=> e.target.value = onlyDigits(e.target.value).slice(0,4));

    // Signature Pad
    const canvas = document.getElementById('signaturePad');
    function resizeCanvasForHiDPI(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width  = rect.width * ratio;
      canvas.height = rect.height * ratio;
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
    }
    let signaturePad;
    function initSignature(){
      resizeCanvasForHiDPI();
      signaturePad = new SignaturePad(canvas, {
        backgroundColor:'#ffffff',
        penColor:'#111827',
        minWidth:0.7, maxWidth:2.2, throttle:0
      });
      canvas.addEventListener('mouseup', renderPreview);
      canvas.addEventListener('touchend', renderPreview);
    }
    initSignature();
    window.addEventListener('resize', ()=>{
      const data = signaturePad.toData();
      resizeCanvasForHiDPI();
      signaturePad.clear();
      signaturePad.fromData(data);
    });
    $('#btnLimpar').addEventListener('click', (e)=>{ e.preventDefault(); signaturePad.clear(); renderPreview(); });

    function getValues(){
      return {
        titular_nome: $('#titular_nome').value.trim(),
        titular_cpf: $('#titular_cpf').value.trim(),
        ultimos4: onlyDigits($('#ultimos4').value).slice(0,4),
        bandeira: $('#bandeira').value.trim(),
        contratante_nome: $('#contratante_nome').value.trim(),
        contratante_cpf: $('#contratante_cpf').value.trim(),
        aceite: $('#aceite').checked,
        data: $('#data_assinatura').value
      };
    }

    function renderPreview(){
      const v = getValues();
      $('#doc_data').textContent = formatDateBR(v.data);
      $('#pv_titular_nome').textContent = v.titular_nome;
      $('#pv_titular_cpf').textContent = v.titular_cpf;
      $('#pv_u4').textContent = v.ultimos4;
      $('#pv_bandeira').textContent = v.bandeira || '—';
      $('#pv_contratante_nome').textContent = v.contratante_nome;
      $('#pv_contratante_cpf').textContent = v.contratante_cpf;
      $('#tt_pre_titular').textContent = v.titular_nome || '____________________________';
      $('#tt_pre_cpf_titular').textContent = v.titular_cpf || '___.___.___-__';
      $('#tt_pre_u4').textContent = v.ultimos4 || '____';
      $('#tt_pre_contratante').textContent = v.contratante_nome || '____________________________';
      $('#tt_pre_cpf_contratante').textContent = v.contratante_cpf || '___.___.___-__';
      const dataUrl = signaturePad.isEmpty() ? '' : signaturePad.toDataURL('image/png');
      $('#pv_assinatura').src = dataUrl;
    }

    function validateForPDF(v){
      if (!v.titular_nome) return 'Informe o nome completo do TITULAR.';
      if (!isValidCPF(v.titular_cpf)) return 'CPF do TITULAR inválido.';
      if (!v.contratante_nome) return 'Informe o nome completo do CONTRATANTE.';
      if (!isValidCPF(v.contratante_cpf)) return 'CPF do CONTRATANTE inválido.';
      if (!v.ultimos4 || v.ultimos4.length !== 4) return 'Informe os 4 últimos dígitos do cartão.';
      if (!v.aceite) return 'Você precisa aceitar o termo.';
      if (signaturePad.isEmpty()) return 'Assine no quadro antes de gerar o PDF.';
      return null;
    }

    async function generatePDF(){
      const v = getValues();
      const err = validateForPDF(v);
      if (err){ alert(err); return; }
      $('#doc_id').textContent = docId();
      renderPreview();
      const area = document.getElementById('printArea');
      const canvasImg = await html2canvas(area, { scale: 2, useCORS: true });
      const imgData = canvasImg.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgProps = { w: pageWidth - 20, h: (canvasImg.height * (pageWidth - 20)) / canvasImg.width };
      const x = 10, y = 10;
      pdf.addImage(imgData, 'PNG', x, y, imgProps.w, imgProps.h, undefined, 'FAST');
      const filename = `DUO_Autorizacao_Terceiros_${$('#doc_id').textContent}.pdf`;
      pdf.save(filename);
    }

    ['titular_nome','titular_cpf','ultimos4','bandeira','contratante_nome','contratante_cpf','aceite','data_assinatura'].forEach(id => {
      const el = document.getElementById(id);
      el && el.addEventListener('input', renderPreview);
      el && el.addEventListener('change', renderPreview);
    });

    $('#btnPDF').addEventListener('click', (e)=>{ e.preventDefault(); generatePDF(); });
    $('#btnReset').addEventListener('click', (e)=>{ e.preventDefault(); if(confirm('Limpar todos os campos?')) location.reload(); });

    setTodayBR();
    renderPreview();
  </script>
</body>
</html>
